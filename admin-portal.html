<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Portal - LINQXFITNESS</title>
    <link rel="stylesheet" href="HomePage.css">
  <style>
        /* Admin Portal Specific Styles */
    .admin-container {
      max-width: 1400px;
      margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            min-height: 100vh;
    }

    .admin-header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .admin-header h1 {
      color: white;
            margin: 0;
            font-size: 2.5rem;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .admin-nav {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .admin-nav button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .admin-nav button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .stats-grid {
      display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
    }

    .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
      border-radius: 15px;
            padding: 25px;
      text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
    }

    .stat-number {
            font-size: 3rem;
      font-weight: bold;
            color: #fbbf24;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .stat-label {
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .controls-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            color: white;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .control-group input,
        .control-group select {
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }

        .add-customer-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
      cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .add-customer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .customers-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .customers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
    }

    .customer-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .customer-card:hover {
      transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    .customer-header {
      display: flex;
      align-items: center;
            margin-bottom: 15px;
    }

    .customer-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #1e3a8a 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 1.2rem;
            margin-right: 15px;
    }

    .customer-info h3 {
      margin: 0;
            color: #1e3a8a;
            font-size: 1.3rem;
    }

    .customer-info p {
            margin: 5px 0 0 0;
            color: #6b7280;
      font-size: 0.9rem;
    }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 5px;
        }

        .status-active {
            background: #dcfce7;
            color: #166534;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-inactive {
            background: #fee2e2;
            color: #991b1b;
        }

    .customer-details {
            margin: 15px 0;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
            margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .detail-label {
            font-weight: 600;
            color: #374151;
    }

    .detail-value {
            color: #6b7280;
    }

    .customer-actions {
      display: flex;
            gap: 10px;
            margin-top: 15px;
    }

    .action-btn {
            flex: 1;
            padding: 10px;
      border: none;
            border-radius: 8px;
            font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1e3a8a 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #374151 100%);
      color: white;
    }

        .action-btn:hover {
      transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .no-customers {
            text-align: center;
            color: white;
            font-size: 1.2rem;
            padding: 40px;
            display: none;
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.2rem;
            padding: 40px;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
      font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .toast-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .toast-error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px;
            border-bottom: 1px solid #e5e7eb;
            background: linear-gradient(135deg, #3b82f6 0%, #1e3a8a 100%);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-form {
            padding: 25px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
        flex-direction: column;
      }

        .form-group label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .modal-actions button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: 1fr;
      }

      .customers-grid {
        grid-template-columns: 1fr;
      }
            
            .admin-nav {
                flex-direction: column;
                align-items: center;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 10px;
            }

            .modal-actions {
                flex-direction: column;
            }
    }
  </style>
</head>
<body>
    <div class="admin-container">
      <!-- Admin Header -->
      <div class="admin-header">
            <h1>üèÜ Admin Portal - LINQXFITNESS</h1>
            <div class="admin-nav">
                <button onclick="window.location.href='admin-schedule.html'">üìÖ Manage Schedule</button>
                <button onclick="window.location.href='admin-workout-plans.html'">üí™ Workout Plans</button>
                <button onclick="adminPortal.refreshData()">üîÑ Refresh</button>
                <button onclick="adminPortal.exportData()">üìä Export Data</button>
                <button onclick="adminPortal.logout()">üö™ Logout</button>
        </div>
      </div>

        <!-- Statistics -->
        <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number" id="totalCustomers">0</div>
            <div class="stat-label">Total Customers</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="activeCustomers">0</div>
                <div class="stat-label">Active Customers</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="pendingCustomers">0</div>
                <div class="stat-label">Pending Customers</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="newThisWeek">0</div>
            <div class="stat-label">New This Week</div>
        </div>
      </div>

        <!-- Controls -->
        <div class="controls-section">
            <div class="controls-grid">
                <div class="control-group">
                    <label for="searchInput">üîç Search Customers</label>
                    <input type="text" id="searchInput" placeholder="Search by name, email, or phone...">
        </div>
                <div class="control-group">
                    <label for="statusFilter">üìä Filter by Status</label>
                    <select id="statusFilter">
                        <option value="all">All Statuses</option>
          <option value="active">Active</option>
          <option value="pending">Pending</option>
          <option value="inactive">Inactive</option>
        </select>
                </div>
                <div class="control-group">
                    <label for="sortBy">üìà Sort By</label>
                    <select id="sortBy">
                        <option value="name">Name</option>
                        <option value="date">Join Date</option>
                        <option value="status">Status</option>
        </select>
                </div>
            </div>
            <button class="add-customer-btn" onclick="adminPortal.showAddCustomerModal()">
                ‚ûï Add New Customer
            </button>
      </div>

        <!-- Customers Section -->
        <div class="customers-section">
            <h2 style="color: white; margin-bottom: 20px;">üë• Customer Management</h2>
            <div id="loadingMessage" class="loading">üîÑ Loading customers...</div>
            <div id="noCustomers" class="no-customers">
                üì≠ No customers found. Add your first customer to get started!
            </div>
            <div id="customersGrid" class="customers-grid" style="display: none;">
        <!-- Customer cards will be populated here -->
      </div>
        </div>
    </div>

    <!-- Add Customer Modal -->
    <div id="addCustomerModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï Add New Customer</h2>
                <button class="modal-close" onclick="adminPortal.hideAddCustomerModal()">&times;</button>
            </div>
            <form id="addCustomerForm" class="modal-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="firstName">First Name *</label>
                        <input type="text" id="firstName" name="firstName" required>
                    </div>
                    <div class="form-group">
                        <label for="lastName">Last Name *</label>
                        <input type="text" id="lastName" name="lastName" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="email">Email *</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone</label>
                        <input type="tel" id="phone" name="phone">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="trainingLevel">Training Level</label>
                        <select id="trainingLevel" name="trainingLevel">
                            <option value="beginner">Beginner</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                            <option value="professional">Professional</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select id="status" name="status">
                            <option value="active">Active</option>
                            <option value="pending">Pending</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="notes">Notes</label>
                    <textarea id="notes" name="notes" rows="3" placeholder="Additional notes about the customer..."></textarea>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="adminPortal.hideAddCustomerModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Add Customer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase CDN -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, getDoc, addDoc, updateDoc, deleteDoc, doc, query, orderBy, where, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // Firebase configuration - hardcoded for linox-soccer project
        const firebaseConfig = {
            apiKey: "AIzaSyCIrzE92nfyWeCxqpX1KcR2c_Rs1ubviy4",
            authDomain: "linox-soccer.firebaseapp.com",
            projectId: "linox-soccer",
            storageBucket: "linox-soccer.firebasestorage.app",
            messagingSenderId: "313058607377",
            appId: "1:313058607377:web:784530fe05a04272dd4cb0",
            measurementId: "G-QQJD06D5RK"
        };

        console.log('‚úÖ Using Firebase configuration for linox-soccer project');

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Admin Portal Class
        class AdminPortalFirebase {
            constructor() {
                this.customers = [];
                this.filteredCustomers = [];
                this.currentUser = null;
                this.init();
            }

            async init() {
                await this.checkAdminAuth();
                await this.loadCustomers();
                this.setupEventListeners();
                await this.updateStats();
            }

            async checkAdminAuth() {
                // Check if user is authenticated and is admin
                return new Promise((resolve, reject) => {
                    console.log('üîç Checking admin authentication...');
                    
                    // Add a small delay to ensure Firebase auth has initialized
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        console.log('üîê Auth state changed:', user ? `User: ${user.email}` : 'No user');
                        
                        if (!user) {
                            // Give Firebase a moment to load the session
                            // If still no user after a delay, then redirect
                            setTimeout(() => {
                                const currentUser = auth.currentUser;
                                if (!currentUser) {
                                    console.error('‚ùå No authenticated user found');
                                    alert('Access denied. Please log in.');
                                    window.location.href = 'loginPage.html';
                                    reject('No user');
                                }
                            }, 500);
                            return;
                        }

                        // User is authenticated, now check if they're admin
                        try {
                            console.log('‚úÖ User authenticated, checking admin status...');
                            
                            // Use doc() to get the user document by UID (document ID)
                            const userDocRef = doc(db, 'users', user.uid);
                            const userDocSnap = await getDoc(userDocRef);
                            
                            if (!userDocSnap.exists()) {
                                console.error('‚ùå User document not found in Firestore for UID:', user.uid);
                                alert('Access denied. Admin privileges required. User profile not found.');
                                window.location.href = 'dashboard.html';
                                unsubscribe();
                                reject('No user document');
                                return;
                            }

                            const userData = userDocSnap.data();
                            console.log('üìÑ User data loaded:', {
                                email: userData.email,
                                isAdmin: userData.isAdmin,
                                isActive: userData.isActive
                            });
                            
                            if (!userData.isAdmin) {
                                console.error('‚ùå User is not admin');
                                alert('Access denied. Admin privileges required.');
                                window.location.href = 'dashboard.html';
                                unsubscribe();
                                reject('Not admin');
                                return;
                            }

                            console.log('‚úÖ Admin access granted!');
                            this.currentUser = user;
                            unsubscribe(); // Stop listening once we've verified
                            resolve();
                        } catch (error) {
                            console.error('‚ùå Auth check error:', error);
                            alert('Authentication error. Please try again.');
                            window.location.href = 'loginPage.html';
                            unsubscribe();
                            reject(error);
                        }
                    });
                });
            }

            async loadCustomers() {
                try {
                    document.getElementById('loadingMessage').style.display = 'block';
                    document.getElementById('customersGrid').style.display = 'none';
                    document.getElementById('noCustomers').style.display = 'none';

                    const customersRef = collection(db, 'customers');
                    const q = query(customersRef, orderBy('createdAt', 'desc'));
                    const querySnapshot = await getDocs(q);
                    
                    this.customers = [];
                    querySnapshot.forEach((doc) => {
                        this.customers.push({ id: doc.id, ...doc.data() });
                    });
                    
                    this.filteredCustomers = [...this.customers];
                    this.renderCustomers();
                    document.getElementById('loadingMessage').style.display = 'none';
                } catch (error) {
                    console.error('Error loading customers:', error);
                    this.showError('Failed to load customers: ' + error.message);
                    document.getElementById('loadingMessage').style.display = 'none';
                }
            }

            setupEventListeners() {
                // Search functionality
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        this.filterCustomers();
                    });
                }

                // Status filter
                const statusFilter = document.getElementById('statusFilter');
                if (statusFilter) {
                    statusFilter.addEventListener('change', (e) => {
                        this.filterCustomers();
                    });
                }

                // Sort functionality
                const sortBy = document.getElementById('sortBy');
                if (sortBy) {
                    sortBy.addEventListener('change', (e) => {
                        this.filterCustomers();
                    });
                }
            }

            filterCustomers() {
                const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
                const statusFilter = document.getElementById('statusFilter')?.value || 'all';
                const sortBy = document.getElementById('sortBy')?.value || 'name';

                // Filter by search term
                let filtered = this.customers.filter(customer => {
                    const matchesSearch = !searchTerm || 
                        customer.firstName?.toLowerCase().includes(searchTerm) ||
                        customer.lastName?.toLowerCase().includes(searchTerm) ||
                        customer.email?.toLowerCase().includes(searchTerm) ||
                        customer.phone?.includes(searchTerm);

                    const matchesStatus = statusFilter === 'all' || customer.status === statusFilter;

                    return matchesSearch && matchesStatus;
                });

                // Sort customers
                filtered.sort((a, b) => {
                    switch (sortBy) {
                        case 'name':
                            return `${a.firstName} ${a.lastName}`.localeCompare(`${b.firstName} ${b.lastName}`);
                        case 'date':
                            return new Date(b.createdAt?.toDate() || 0) - new Date(a.createdAt?.toDate() || 0);
                        case 'status':
                            return a.status.localeCompare(b.status);
                        default:
                            return 0;
                    }
                });

                this.filteredCustomers = filtered;
                this.renderCustomers();
            }

            renderCustomers() {
                const grid = document.getElementById('customersGrid');
                const noCustomers = document.getElementById('noCustomers');

                if (!grid) return;

                if (this.filteredCustomers.length === 0) {
                    grid.style.display = 'none';
                    if (noCustomers) noCustomers.style.display = 'block';
                    return;
                }

                grid.style.display = 'grid';
                if (noCustomers) noCustomers.style.display = 'none';

                grid.innerHTML = this.filteredCustomers.map(customer => this.createCustomerCard(customer)).join('');
            }

            createCustomerCard(customer) {
                const statusClass = `status-${customer.status}`;
                const statusText = customer.status.charAt(0).toUpperCase() + customer.status.slice(1);
                const initials = `${customer.firstName?.[0] || ''}${customer.lastName?.[0] || ''}`.toUpperCase();
                const joinDate = customer.createdAt ? customer.createdAt.toDate().toLocaleDateString() : 'Unknown';
                const lastActivity = customer.lastActivity || 'Never';

                return `
                    <div class="customer-card" data-customer-id="${customer.id}">
                        <div class="customer-header">
                            <div class="customer-avatar">
                                ${customer.profilePhoto ? 
                                    `<img src="${customer.profilePhoto}" alt="${customer.firstName} ${customer.lastName}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" />` : 
                                    initials
                                }
                            </div>
                            <div class="customer-info">
                                <h3>${customer.firstName} ${customer.lastName}</h3>
                                <p>${customer.email}</p>
                                <span class="status-badge ${statusClass}">${statusText}</span>
      </div>
    </div>

                        <div class="customer-details">
                            <div class="detail-row">
                                <span class="detail-label">Phone:</span>
                                <span class="detail-value">${customer.phone || 'Not provided'}</span>
          </div>
                            <div class="detail-row">
                                <span class="detail-label">Join Date:</span>
                                <span class="detail-value">${joinDate}</span>
        </div>
                            <div class="detail-row">
                                <span class="detail-label">Training Level:</span>
                                <span class="detail-value">${customer.trainingLevel || 'Not Set'}</span>
        </div>
                            <div class="detail-row">
                                <span class="detail-label">Last Activity:</span>
                                <span class="detail-value">${lastActivity}</span>
        </div>
      </div>

                        <div class="customer-actions">
                            <button class="action-btn btn-primary" onclick="adminPortal.viewCustomer('${customer.id}')">
                                View Details
                            </button>
                            <button class="action-btn btn-secondary" onclick="adminPortal.manageSchedule('${customer.id}')">
                                Manage Schedule
                            </button>
                            <button class="action-btn btn-secondary" onclick="adminPortal.recommendExercises('${customer.id}')">
                                Recommend Exercises
                            </button>
      </div>
    </div>
                `;
            }

            async updateStats() {
                try {
                    const stats = {
                        total: this.customers.length,
                        active: this.customers.filter(c => c.status === 'active').length,
                        pending: this.customers.filter(c => c.status === 'pending').length,
                        newThisWeek: 0
                    };
                    
                    // Calculate new customers this week
                    const oneWeekAgo = new Date();
                    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                    stats.newThisWeek = this.customers.filter(c => {
                        if (c.createdAt && c.createdAt.toDate) {
                            return c.createdAt.toDate() > oneWeekAgo;
                        }
                        return false;
                    }).length;

                    document.getElementById('totalCustomers').textContent = stats.total;
                    document.getElementById('activeCustomers').textContent = stats.active;
                    document.getElementById('pendingCustomers').textContent = stats.pending;
                    document.getElementById('newThisWeek').textContent = stats.newThisWeek;
                } catch (error) {
                    console.error('Error updating stats:', error);
                }
            }

            async viewCustomer(customerId) {
                // Navigate to customer detail page
                window.location.href = `customer-details.html?id=${customerId}`;
            }

            async manageSchedule(customerId) {
                // Navigate to schedule management page
                window.location.href = `customer-schedule.html?id=${customerId}`;
            }

            async recommendExercises(customerId) {
                // Navigate to exercise recommendation page
                window.location.href = `customer-exercises.html?id=${customerId}`;
            }

            showAddCustomerModal() {
                document.getElementById('addCustomerModal').style.display = 'flex';
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            }

            hideAddCustomerModal() {
                document.getElementById('addCustomerModal').style.display = 'none';
                document.body.style.overflow = 'auto'; // Restore scrolling
                document.getElementById('addCustomerForm').reset();
            }

            async addCustomer(customerData) {
                try {
                    const customerRef = collection(db, 'customers');
                    const customerDoc = {
                        ...customerData,
                        createdAt: serverTimestamp(),
                        lastActivity: 'Never',
                        profilePhoto: null
                    };
                    
                    await addDoc(customerRef, customerDoc);
                    this.showSuccess('Customer added successfully!');
                    this.hideAddCustomerModal();
                    await this.loadCustomers();
                    await this.updateStats();
                } catch (error) {
                    console.error('Error adding customer:', error);
                    this.showError('Failed to add customer: ' + error.message);
                }
            }

            async refreshData() {
                await this.loadCustomers();
                await this.updateStats();
                this.showSuccess('Data refreshed successfully');
            }

            exportData() {
                // Export customers data as JSON
                const dataStr = JSON.stringify(this.customers, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'customers-export.json';
                link.click();
                URL.revokeObjectURL(url);
                this.showSuccess('Data exported successfully');
            }

            async logout() {
                try {
                    await signOut(auth);
                    window.location.href = 'loginPage.html';
                } catch (error) {
                    console.error('Logout error:', error);
                    window.location.href = 'loginPage.html';
                }
            }

            showSuccess(message) {
                this.showMessage(message, 'success');
            }

            showError(message) {
                this.showMessage(message, 'error');
            }

            showMessage(message, type) {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 5000);
            }
        }

        // Initialize admin portal when page loads
        let adminPortal;
        document.addEventListener('DOMContentLoaded', () => {
            adminPortal = new AdminPortalFirebase();
            // Expose to global scope for onclick handlers
            window.adminPortal = adminPortal;
            
            // Handle add customer form submission
            const addCustomerForm = document.getElementById('addCustomerForm');
            if (addCustomerForm) {
                addCustomerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const formData = new FormData(addCustomerForm);
                    const customerData = {
                        firstName: formData.get('firstName'),
                        lastName: formData.get('lastName'),
                        email: formData.get('email'),
                        phone: formData.get('phone') || '',
                        trainingLevel: formData.get('trainingLevel'),
                        status: formData.get('status'),
                        notes: formData.get('notes') || ''
                    };
                    
                    await adminPortal.addCustomer(customerData);
                });
            }
            
            // Handle modal close on background click
            const modal = document.getElementById('addCustomerModal');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        adminPortal.hideAddCustomerModal();
                    }
                });
            }
        });

        // Export for global access
        window.adminPortal = adminPortal;
    </script>
</body>
</html>
